From 1a71d7adb85587d2d9c6b0e2b9e8c4c97820b44d Mon Sep 17 00:00:00 2001
From: Perttu Ahola <celeron55@gmail.com>
Date: Fri, 3 Jan 2014 03:15:59 +0200
Subject: [PATCH 8/8] OGLES1 on Sailfish+SDL2

---
 include/IrrCompileConfig.h         | 11 ++++++--
 source/Irrlicht/CIrrDeviceSDL2.cpp | 56 ++++++++++++++++++++++++++++++++++++--
 source/Irrlicht/COGLESDriver.cpp   | 14 +++++-----
 source/Irrlicht/COGLESDriver.h     |  4 +--
 4 files changed, 72 insertions(+), 13 deletions(-)

diff --git a/include/IrrCompileConfig.h b/include/IrrCompileConfig.h
index ad399d1..2f99fdd 100644
--- a/include/IrrCompileConfig.h
+++ b/include/IrrCompileConfig.h
@@ -115,8 +115,15 @@
 
 #if defined(_IRR_SAILFISH_PLATFORM_)
 #define _IRR_POSIX_API_
-#define NO_IRR_COMPILE_WITH_OGLES1_
-#define _IRR_COMPILE_WITH_OGLES2_
+
+// -OGLES1 +OGLES2
+//#define NO_IRR_COMPILE_WITH_OGLES1_
+//#define _IRR_COMPILE_WITH_OGLES2_
+
+// +OGLES1 -OGLES2
+#define _IRR_COMPILE_WITH_OGLES1_
+#define NO_IRR_COMPILE_WITH_OGLES2_
+
 #define _IRR_COMPILE_WITH_SDL2_DEVICE_
 #define NO_IRR_COMPILE_WITH_X11_
 #endif
diff --git a/source/Irrlicht/CIrrDeviceSDL2.cpp b/source/Irrlicht/CIrrDeviceSDL2.cpp
index 528c0d4..d7bc8df 100644
--- a/source/Irrlicht/CIrrDeviceSDL2.cpp
+++ b/source/Irrlicht/CIrrDeviceSDL2.cpp
@@ -43,6 +43,11 @@ namespace irr
 				io::IFileSystem* io, CIrrDeviceSDL2* device);
 		#endif
 
+        #ifdef _IRR_COMPILE_WITH_OGLES1_
+		IVideoDriver* createOGLES1Driver(const SIrrlichtCreationParameters& params,
+			io::IFileSystem* io, video::IContextManager* contextManager);
+        #endif
+
         #ifdef _IRR_COMPILE_WITH_OGLES2_ 	 
         //IVideoDriver* createOGLES2Driver(const SIrrlichtCreationParameters& params, video::SExposedVideoData& data, io::IFileSystem* io);
         IVideoDriver* createOGLES2Driver(const SIrrlichtCreationParameters& params, io::IFileSystem* io, IContextManager* contextManager);
@@ -70,7 +75,7 @@ CIrrDeviceSDL2::CIrrDeviceSDL2(const SIrrlichtCreationParameters& param)
 	// Initialize SDL... Timer for sleep, video for the obvious, and
 	// noparachute prevents SDL from catching fatal errors.
 	if (SDL_Init( SDL_INIT_TIMER|SDL_INIT_VIDEO|
-#if defined(_IRR_COMPILE_WITH_JOYSTICK_EVENTS_)
+#if 0 && defined(_IRR_COMPILE_WITH_JOYSTICK_EVENTS_)
 				SDL_INIT_JOYSTICK|
 #endif
 				SDL_INIT_NOPARACHUTE ) < 0)
@@ -144,7 +149,7 @@ CIrrDeviceSDL2::CIrrDeviceSDL2(const SIrrlichtCreationParameters& param)
 //! destructor
 CIrrDeviceSDL2::~CIrrDeviceSDL2()
 {
-#if defined(_IRR_COMPILE_WITH_JOYSTICK_EVENTS_)
+#if 0 && defined(_IRR_COMPILE_WITH_JOYSTICK_EVENTS_)
 	const u32 numJoysticks = Joysticks.size();
 	for (u32 i=0; i<numJoysticks; ++i)
 		SDL_JoystickClose(Joysticks[i]);
@@ -282,6 +287,53 @@ void CIrrDeviceSDL2::createDriver()
 		#endif
 		break;
 
+    case video::EDT_OGLES1: 	 
+        #ifdef _IRR_COMPILE_WITH_OGLES1_
+        {
+            video::SExposedVideoData data;
+			switch(Info.subsystem){
+			case SDL_SYSWM_X11:
+				os::Printer::log("Subsystem for sdl2/ogles: X11", ELL_INFORMATION);
+			#if defined(SDL_VIDEO_DRIVER_X11)
+				data.OpenGLLinux.X11Window = Info.info.x11.window; // Should be wl_egl_window
+				data.OpenGLLinux.X11Display = Info.info.x11.display;
+			#else
+				os::Printer::log("Subsystem for sdl2/ogles: X11: not supported", ELL_ERROR);
+			#endif
+				break;
+			case SDL_SYSWM_WAYLAND: {
+				os::Printer::log("Subsystem for sdl2/ogles: Wayland", ELL_INFORMATION);
+			#if defined(SDL_VIDEO_DRIVER_WAYLAND)
+				void *egl_window = wl_egl_window_create(Info.info.wl.surface, Width, Height);
+				if(!egl_window){
+					os::Printer::log("Wayland: Failed to create EGL window", ELL_ERROR);
+					Close = true;
+					return;
+				}
+				//data.OpenGLLinux.X11Window = (long unsigned int)Info.info.wl.surface; // Should be wl_egl_window
+				data.OpenGLLinux.X11Window = (long unsigned int)egl_window;
+				data.OpenGLLinux.X11Display = Info.info.wl.display;
+			#else
+				os::Printer::log("Subsystem for sdl2/ogles: Wayland: not supported", ELL_ERROR);
+			#endif
+				break; }
+			case SDL_SYSWM_UNKNOWN:
+				os::Printer::log("Subsystem for sdl2/ogles: SDL reports unknown: "
+						"not supported", ELL_ERROR);
+				break;
+			default:
+				os::Printer::log("Subsystem for sdl2/ogles: Unimplemented",
+						ELL_INFORMATION);
+			}
+            ContextManager = new video::CEGLManager();
+			ContextManager->initialize(CreationParams, data);
+            VideoDriver = video::createOGLES1Driver(CreationParams, FileSystem, ContextManager);
+        }
+        #else
+        os::Printer::log("No OpenGL-ES support compiled in.", ELL_ERROR); 	 
+        #endif 	 
+        break;
+
     case video::EDT_OGLES2: 	 
         #ifdef _IRR_COMPILE_WITH_OGLES2_
         {
diff --git a/source/Irrlicht/COGLESDriver.cpp b/source/Irrlicht/COGLESDriver.cpp
index 7f5a6b7..0feb4ac 100644
--- a/source/Irrlicht/COGLESDriver.cpp
+++ b/source/Irrlicht/COGLESDriver.cpp
@@ -25,7 +25,7 @@ namespace video
 
 COGLES1Driver::COGLES1Driver(const SIrrlichtCreationParameters& params,
             io::IFileSystem* io
-#if defined(_IRR_COMPILE_WITH_X11_DEVICE_) || defined(_IRR_WINDOWS_API_) || defined(_IRR_COMPILE_WITH_ANDROID_DEVICE_)
+#if defined(_IRR_COMPILE_WITH_X11_DEVICE_) || defined(_IRR_WINDOWS_API_) || defined(_IRR_COMPILE_WITH_ANDROID_DEVICE_) || defined(_IRR_COMPILE_WITH_SDL2_DEVICE_)
             , IContextManager* contextManager
 #elif defined(_IRR_COMPILE_WITH_IPHONE_DEVICE_)
             , CIrrDeviceIPhone* device
@@ -34,7 +34,7 @@ COGLES1Driver::COGLES1Driver(const SIrrlichtCreationParameters& params,
 	CurrentRenderMode(ERM_NONE), ResetRenderStates(true),
 	Transformation3DChanged(true), AntiAlias(params.AntiAlias),
 	RenderTargetTexture(0), CurrentRendertargetSize(0,0), ColorFormat(ECF_R8G8B8)
-#if defined(_IRR_COMPILE_WITH_X11_DEVICE_) || defined(_IRR_WINDOWS_API_) || defined(_IRR_COMPILE_WITH_ANDROID_DEVICE_)
+#if defined(_IRR_COMPILE_WITH_X11_DEVICE_) || defined(_IRR_WINDOWS_API_) || defined(_IRR_COMPILE_WITH_ANDROID_DEVICE_) || defined(_IRR_COMPILE_WITH_SDL2_DEVICE_)
     , ContextManager(contextManager)
 #elif defined(_IRR_COMPILE_WITH_IPHONE_DEVICE_)
     , Device(device), ViewFramebuffer(0),
@@ -47,7 +47,7 @@ COGLES1Driver::COGLES1Driver(const SIrrlichtCreationParameters& params,
 
     core::dimension2d<u32> WindowSize(0, 0);
 
-#if defined(_IRR_COMPILE_WITH_X11_DEVICE_) || defined(_IRR_WINDOWS_API_) || defined(_IRR_COMPILE_WITH_ANDROID_DEVICE_)
+#if defined(_IRR_COMPILE_WITH_X11_DEVICE_) || defined(_IRR_WINDOWS_API_) || defined(_IRR_COMPILE_WITH_ANDROID_DEVICE_) || defined(_IRR_COMPILE_WITH_SDL2_DEVICE_)
 	if (!ContextManager)
 		return;
 
@@ -99,7 +99,7 @@ COGLES1Driver::~COGLES1Driver()
 	deleteMaterialRenders();
 	deleteAllTextures();
 
-#if defined(_IRR_COMPILE_WITH_X11_DEVICE_) || defined(_IRR_WINDOWS_API_) || defined(_IRR_COMPILE_WITH_ANDROID_DEVICE_)
+#if defined(_IRR_COMPILE_WITH_X11_DEVICE_) || defined(_IRR_WINDOWS_API_) || defined(_IRR_COMPILE_WITH_ANDROID_DEVICE_) || defined(_IRR_COMPILE_WITH_SDL2_DEVICE_)
 	if (ContextManager)
 	{
 		ContextManager->destroyContext();
@@ -271,7 +271,7 @@ bool COGLES1Driver::endScene()
 {
 	CNullDriver::endScene();
 
-#if defined(_IRR_COMPILE_WITH_X11_DEVICE_) || defined(_IRR_WINDOWS_API_) || defined(_IRR_COMPILE_WITH_ANDROID_DEVICE_)
+#if defined(_IRR_COMPILE_WITH_X11_DEVICE_) || defined(_IRR_WINDOWS_API_) || defined(_IRR_COMPILE_WITH_ANDROID_DEVICE_) || defined(_IRR_COMPILE_WITH_SDL2_DEVICE_)
     ContextManager->swapBuffers();
 #elif defined(_IRR_COMPILE_WITH_IPHONE_DEVICE_)
     glFlush();
@@ -3037,7 +3037,7 @@ class IContextManager;
 
 IVideoDriver* createOGLES1Driver(const SIrrlichtCreationParameters& params,
 		io::IFileSystem* io
-#if defined(_IRR_COMPILE_WITH_X11_DEVICE_) || defined(_IRR_WINDOWS_API_) || defined(_IRR_COMPILE_WITH_ANDROID_DEVICE_)
+#if defined(_IRR_COMPILE_WITH_X11_DEVICE_) || defined(_IRR_WINDOWS_API_) || defined(_IRR_COMPILE_WITH_ANDROID_DEVICE_) || defined(_IRR_COMPILE_WITH_SDL2_DEVICE_)
         , IContextManager* contextManager
 #elif defined(_IRR_COMPILE_WITH_IPHONE_DEVICE_)
         , CIrrDeviceIPhone* device
@@ -3046,7 +3046,7 @@ IVideoDriver* createOGLES1Driver(const SIrrlichtCreationParameters& params,
 {
 #ifdef _IRR_COMPILE_WITH_OGLES1_
 	return new COGLES1Driver(params, io
-#if defined(_IRR_COMPILE_WITH_X11_DEVICE_) || defined(_IRR_WINDOWS_API_) || defined(_IRR_COMPILE_WITH_ANDROID_DEVICE_)
+#if defined(_IRR_COMPILE_WITH_X11_DEVICE_) || defined(_IRR_WINDOWS_API_) || defined(_IRR_COMPILE_WITH_ANDROID_DEVICE_) || defined(_IRR_COMPILE_WITH_SDL2_DEVICE_)
         , contextManager
 #elif defined(_IRR_COMPILE_WITH_IPHONE_DEVICE_)
         , device
diff --git a/source/Irrlicht/COGLESDriver.h b/source/Irrlicht/COGLESDriver.h
index b35a03e..9689c27 100644
--- a/source/Irrlicht/COGLESDriver.h
+++ b/source/Irrlicht/COGLESDriver.h
@@ -35,7 +35,7 @@ namespace video
 		//! constructor
 		COGLES1Driver(const SIrrlichtCreationParameters& params,
 				io::IFileSystem* io
-#if defined(_IRR_COMPILE_WITH_X11_DEVICE_) || defined(_IRR_WINDOWS_API_) || defined(_IRR_COMPILE_WITH_ANDROID_DEVICE_)
+#if defined(_IRR_COMPILE_WITH_X11_DEVICE_) || defined(_IRR_WINDOWS_API_) || defined(_IRR_COMPILE_WITH_ANDROID_DEVICE_) || defined(_IRR_COMPILE_WITH_SDL2_DEVICE_)
                 , IContextManager* contextManager
 #elif defined(_IRR_COMPILE_WITH_IPHONE_DEVICE_)
                 , CIrrDeviceIPhone* device
@@ -371,7 +371,7 @@ namespace video
 		GLuint ViewFramebuffer;
 		GLuint ViewRenderbuffer;
 		GLuint ViewDepthRenderbuffer;
-#elif defined(_IRR_COMPILE_WITH_X11_DEVICE_) || defined(_IRR_WINDOWS_API_) || defined(_IRR_COMPILE_WITH_ANDROID_DEVICE_)
+#elif defined(_IRR_COMPILE_WITH_X11_DEVICE_) || defined(_IRR_WINDOWS_API_) || defined(_IRR_COMPILE_WITH_ANDROID_DEVICE_) || defined(_IRR_COMPILE_WITH_SDL2_DEVICE_)
         IContextManager* ContextManager;
 #endif
 	};
-- 
1.8.4.2

